#!/bin/bash
#
# Author: bjpjones@fnal.gov from echurch@fnal.gov from dbox@fnal.gov
#
# Small subset of a script to run the optical library building job on the grid within larbatch infrastructure, modified by pkryczyn@fnal.gov
#
#
# To run this job:
#
# jobsub -X509_USER_PROXY /scratch/[user]/grid/[user].uboone.proxy -N [NoOfJobs] -q OpticalLibraryBuild_Grid.sh `whoami` `pwd`
#
# You will get outputs in the area specified by the "outstage" variable 
# which is specified below.
#
# The form of the output is one file for each few voxels. These then need 
# stitching together, which is done after all jobs are done, with a
# dedicated stitching script.
#

umask 0002
verbose=T

# launchN=5
# Njobs=5000 # 27115 in total, corresponds to numjobs in xml file. 
# NEWPROCESS=`echo "($launchN * $Njobs + $JOBSUBJOBSECTION - 1) " | bc`
# NEWPROCESS=`echo "($launchN * $Njobs + $PROCESS) " | bc`

LOOP=`echo "($JOBSUBJOBSECTION - 1) " | bc`

missing=(10585 10586 10670 10689 10690 10718 10735 10759 10999 11137 11152 11185 11186 11216 11232 11239 11252 11282 11291 11477 11483 11516 11551 11659 11668 11742 11743 11745 11781 11809 11810 11813 11821 11832 1185 11871 11892 1194 1198 12012 1203 12030 12101 12102 12113 12132 12143 12164 12165 12168 12182 12184 12185 12198 12210 12238 12241 12243 12255 12263 12264 12294 12310 12311 12312 12322 12323 12324 12327 12328 12342 12345 12361 12363 12388 12389 12404 12405 12406 12434 1245 12450 12469 12477 12481 12501 12518 12543 12554 12555 12585 12586 1259 12648 12659 12660 12662 1267 12688 1269 12698 1271 12718 12752 12867 13025 13053 13061 13104 13105 13106 13197 13198 1321 13301 13302 13303 13349 13350 13351 13383 13399 13400 13424 13455 13482 13505 13538 13564 13606 13816 13817 1383 13847 13850 13875 13920 13930 13932 1394 13947 13977 1401 14036 1405 14061 1407 1409 1410 14100 14218 14225 14247 14248 14257 14259 14321 14377 14409 14410 14411 14472 14473 14527 14529 1456 14571 14583 14635 14636 14637 14638 14664 14665 14666 14667 14668 14736 14790 14791 14807 14829 14837 14839 14900 14901 14949 14950 15063 15127 15142 15152 15153 15155 15157 15159 15161 15162 15164 15182 15185 15225 15229 15231 15301 15341 15368 15465 15559 15594 15622 15696 15715 1572 1573 1574 1576 1577 15771 1578 1579 15797 15800 1581 15818 1582 1583 1584 15848 1586 1587 1588 15882 15886 1589 15898 1590 1591 1592 15926 1593 1594 1595 15986 15987 16025 16027 16028 16029 16044 16057 16069 16070 16089 16113 16130 16171 16188 16189 16191 16192 16194 16208 16222 16261 16263 16265 16282 16301 16302 16303 16305 16306 16312 16313 16329 16332 16333 16347 16348 16360 16361 16372 16384 16404 16406 16416 16436 16465 16469 165 16512 16539 16558 16593 16596 16732 16791 16818 16825 16841 16860 16916 16940 16941 16995 17033 17034 17137 17138 17184 17185 17186 17234 17241 17244 17291 17316 17373 17442 17444 17624 17651 17652 17653 17654 17682 17683 17708 17728 17729 17768 17785 17786 17815 17817 17819 17830 17894 17976 17977 17978 17979 17980 17981 17982 17983 17985 18059 18060 18138 18139 18140 18144 18147 18148 18150 18152 18153 18157 18159 18198 18199 18200 18201 18207 18218 18219 18220 18221 18222 18223 18224 18225 18226 18230 18234 18281 18283 18284 18285 18288 18354 18361 18364 18456 18457 18469 18472 18473 18481 18483 18512 18582 18583 18584 18585 18587 18621 18631 18634 18690 18691 18692 18760 18761 18833 18834 18858 18859 18860 18900 18914 18915 18936 18993 18994 19074 19109 19110 19111 19112 19114 19157 19206 19207 19248 19249 19251 19294 19324 19358 19359 19472 19493 19545 19580 19581 19640 19641 19660 19661 19662 19688 19705 19734 19736 19770 19771 19772 19773 19776 19845 19882 19936 20120 20122 20140 20146 20148 20151 20180 20183 20184 20558 20572 20599 20654 20663 20682 20688 20703 20713 20814 20816 20818 2090 20917 2102 2104 21066 2111 2115 2120 21215 21267 21280 21281 21282 21283 21318 2136 21572 21573 21574 21575 21621 21702 21703 21719 21758 2177 21775 21777 21781 21782 21808 21810 21822 21823 21824 21842 21843 21845 21846 21855 21866 21867 21868 21890 21917 21954 21975 21980 21985 21988 21990 21992 22004 22026 22085 22097 2212 2215 2226 22267 22281 22350 22414 22415 22423 22424 22425 22433 22434 22436 22437 22439 22440 22442 22443 22446 22447 22448 22452 22505 22509 22510 22521 22536 22538 22544 22547 2263 22671 22678 22680 22698 22699 22706 22713 22714 22718 22721 22724 22726 22730 23016 23218 23231 23233 23236 23237 23239 23342 23360 2346 23478 23671 23696 23704 23708 23712 23717 23819 23836 23840 23841 23862 23863 23869 23872 23875 23876 23945 24105 24117 24120 24236 24244 24251 24255 24256 24257 24272 24345 24360 24365 24531 24572 24726 24727 24843 24981 25029 25035 25036 25055 25062 25064 25066 25067 25070 25094 25100 25101 25495 25559 25576 25585 25587 25630 25762 25802 25844 25973 26029 2618 2619 26257 26451 26458 26459 26493 26518 26553 26743 26773 26788 26789 26790 26811 26813 26814 26823 26824 26825 26850 26852 26856 26858 26870 26881 26906 26922 26949 26951 26974 2702 27045 27048 27049 27051 27072 27114 2741 2742 2744 2745 2746 2757 2759 2901 2913 2965 3003 3056 3131 3159 3240 3423 3427 3431 3451 3461 3492 3493 3527 3528 3544 3545 3546 3569 3577 3601 3612 3613 3615 3617 3629 3630 3631 3652 3680 3700 3724 3767 3769 3770 3784 3785 3787 3792 3811 3819 3836 3866 3867 3868 3911 3918 3957 3978 3979 4018 4130 4131 4132 4133 4134 4211 4212 4296 4354 4356 4360 4410 4491 4612 4640 4689 4691 4710 4811 4813 4913 4916 4922 4930 4932 4981 4982 4987 534 5543 5545 5589 5596 5610 562 5654 5693 571 573 574 5740 5763 5791 5909 591 603 614 617 6187 6214 622 6258 6289 6296 6343 6406 6412 6479 6708 6725 6729 6735 6745 6808 6868 6873 6894 6928 6974 7064 7067 7115 7116 7130 7132 7142 7166 7184 7186 7197 7206 7209 7239 7241 7255 7265 7275 7312 7313 7314 7315 7325 7327 7329 7330 7331 7332 7345 7346 7365 7366 7407 7408 7426 7435 7437 7443 7452 7453 7455 7479 7589 7603 7605 7622 7650 7661 7664 7690 7703 7721 7742 7839 7891 8019 8098 8099 8100 8154 8191 8192 8262 8297 8298 8344 8345 8377 8403 8449 8476 8500 8532 8533 8557 8599 8601 8800 8801 8802 8832 8833 8861 8908 8929 8959 9006 9016 9076 9100 9130 9174 9213 9215 9297 9304 9307 9312 937 9401 9402 9419 9452 9480 9481 9483 9519 9520 9559 9573 9603 9604 9612 9633 9645 9646 9648 9674 9715 9730 9735 9753 9793 9812 9836 9865 9866 9925 9987 9988)

NEWPROCESS=${missing[$LOOP]}

# Copy arguments into meaningful names.
process=${NEWPROCESS}
cluster=${CLUSTER}


# Library building parameters

# In each grid job, do this many voxels:
NVoxelsPerJob=120

# In each voxel, run this many photons:
NPhotonsPerVoxel=500000

# The top voxel for the whole job +1.
NTopVoxel=3253801 

echo $FHICL_FILE_PATH "fhicl file path"
# This works out which voxels this job should focus on: 
FirstVoxel=`echo "($NVoxelsPerJob * $NEWPROCESS ) % $NTopVoxel" | bc`
LastVoxel=`echo "(($NVoxelsPerJob * $NEWPROCESS ) + $NVoxelsPerJob - 1 ) % $NTopVoxel" | bc`


# And then tell the user about it:
echo "This job will run from voxel $FirstVoxel to $LastVoxel, generating $NPhotonsPerVoxel in each"
echo "physics.producers.generator.FirstVoxel: $FirstVoxel" >> $FCL
echo "physics.producers.generator.LastVoxel: $LastVoxel" >> $FCL
echo "physics.producers.generator.N: $NPhotonsPerVoxel">> $FCL
echo "services.TFileService.fileName: \"${process}_hist.root\"" >> $FCL



