#!/bin/bash
#
# Author: bjpjones@fnal.gov from echurch@fnal.gov from dbox@fnal.gov
#
# Small subset of a script to run the optical library building job on the grid within larbatch infrastructure, modified by pkryczyn@fnal.gov
#
#
# To run this job:
#
# jobsub -X509_USER_PROXY /scratch/[user]/grid/[user].uboone.proxy -N [NoOfJobs] -q OpticalLibraryBuild_Grid.sh `whoami` `pwd`
#
# You will get outputs in the area specified by the "outstage" variable 
# which is specified below.
#
# The form of the output is one file for each few voxels. These then need 
# stitching together, which is done after all jobs are done, with a
# dedicated stitching script.
#

umask 0002
verbose=T

# launchN=5
# Njobs=5000 # 27115 in total, corresponds to numjobs in xml file. 
# NEWPROCESS=`echo "($launchN * $Njobs + $JOBSUBJOBSECTION - 1) " | bc`
# NEWPROCESS=`echo "($launchN * $Njobs + $PROCESS) " | bc`

LOOP=`echo "($JOBSUBJOBSECTION) " | bc`

missing=(100 10035 10063 10065 10095 10113 10125 10131 10170 10182 10193 10260 10270 10301 10302 10338 10381 10411 10461 10469 10513 10544 10570 10590 10597 10603 1067 10676 10690 10735 10767 10770 10778 108 10806 10817 10822 1083 10833 10837 1087 10886 10899 1090 10916 10937 10941 11012 11018 11038 11049 11064 11083 11084 11100 11116 11203 11294 11303 1132 11350 11368 11402 11412 11438 11444 1145 11475 11485 11540 11551 11554 11560 11606 11617 11619 1163 11639 11647 11684 11728 11735 11769 1178 11798 11800 11831 11863 11870 11922 11944 11987 12000 12013 12059 12088 12109 1211 12133 12149 12168 12175 12187 12191 12196 12208 1226 12272 1229 12299 12367 1237 12398 12425 12430 12452 12486 12491 12507 12526 12532 12541 12598 1263 12696 12704 1274 12774 12794 12811 12835 12864 12886 12888 12907 12920 12929 12932 12937 12952 12982 12990 13004 13035 13069 13081 1310 13166 13182 13190 13203 13225 13261 13279 13282 1337 13426 1345 13454 13460 13528 1356 13570 13764 13866 13892 13908 13921 13977 13988 13996 14053 14061 14072 14086 14130 14159 14183 14196 1420 14271 14282 14356 14358 14403 14420 14434 14458 14464 145 14518 14548 14559 1466 14679 14681 14729 14734 1474 14761 14766 14785 14824 1486 14881 14908 14913 14949 14973 14977 15001 1501 15067 15086 15089 15117 15151 15153 15236 15249 15290 15293 15327 15379 15382 15390 154 15409 15410 15417 15419 15422 15424 15481 15510 15521 15523 15594 15609 15617 15629 15630 15631 15654 15670 15718 15737 15753 15797 15799 15814 1582 1585 15857 15871 1588 15892 15902 15979 15991 16004 16006 16067 16068 16089 1609 16211 16220 16224 16230 16233 16263 16264 16279 16318 1635 16375 16442 16496 16522 16528 16545 16570 16624 16643 16666 16687 16729 16773 16799 16850 16877 16882 16883 1689 16911 16916 16926 16974 17025 17049 17069 17097 171 17120 17177 17200 17216 17228 17237 17345 17347 17349 17363 17366 1737 17376 17412 17423 17453 1746 17464 17468 17494 1756 17567 17616 17684 17695 177 17700 17701 17798 17810 17823 17829 17895 179 17903 17985 18 180 18007 18016 18053 1809 18112 18122 18128 18136 18145 18198 18205 18258 18335 1836 18369 18438 18459 18475 18490 18538 18550 18559 18568 1858 18592 18645 1867 18676 18709 18723 18732 18811 18832 18837 18841 18917 18934 18946 18990 19035 19151 19171 19184 19211 19223 1923 19266 19275 19285 19292 19298 19332 19346 19354 19369 19373 19459 19492 19515 19569 1959 19600 19630 19640 19654 19669 19704 19747 19793 19794 1983 19830 19852 19963 20041 20044 20067 20088 20093 20100 20124 20128 20211 20230 2026 20294 20303 2031 20326 20336 20357 20377 20388 20404 20411 20418 20444 20456 2047 20483 20489 20491 20528 20552 20554 20564 20577 2058 20585 2059 20608 20660 20663 20680 20703 20710 20732 20753 20754 20777 20799 2080 20811 20817 20860 20877 20938 20942 2098 20998 21003 21020 21028 21110 2113 21160 21184 21197 21227 21291 21369 21370 21371 21431 21439 21503 21507 2153 21544 21555 21582 21611 21629 21734 21746 2175 21810 21813 21816 21847 21909 21918 21925 21961 21982 21993 21996 22007 22037 22050 22061 22066 2208 22205 22260 22295 22297 22313 2235 2238 2241 22433 2245 22474 22532 22558 22565 22595 22607 22653 22680 22686 22732 22784 22788 2280 22800 22816 22856 2287 22872 22888 22890 22895 22944 22963 22983 23028 23061 23106 23128 23193 23199 2321 23230 23245 23246 2326 2330 23322 2333 23353 23366 23408 23466 23578 2359 23595 23655 23657 23705 23716 23719 23722 23751 23757 23792 23842 23888 23892 23956 23996 24002 2407 24176 24212 24285 24300 24323 24329 2434 24355 24389 24425 24477 24483 24496 24499 2451 24526 24533 24552 24598 246 24623 24667 24681 24691 24748 24759 24792 24817 24850 24854 24868 24884 24913 24937 24946 24958 24978 24988 25025 25048 25085 25100 25145 25180 25221 25275 25335 2535 25365 2540 25435 25454 2546 25507 25508 25529 25554 25555 25579 25585 25649 25671 25703 2571 25720 2573 2578 2579 25846 25848 25911 25918 25926 25981 2600 26018 26021 26040 2605 26098 261 26130 26136 26215 26271 26310 26328 26337 26350 26374 26377 26436 2644 26516 26529 26534 26574 26584 26599 26602 26613 26615 26665 26733 2675 26775 26788 26802 26817 26880 26987 26992 26993 270 27094 27095 2719 2735 279 28 2805 2811 2901 2923 2940 2980 2982 2989 2990 2999 3021 3031 3084 3105 3139 3172 3204 322 3222 3243 3246 3253 3321 3328 339 3392 3404 3448 3521 3552 3576 3589 3628 3690 3731 3781 3857 3891 3899 3964 3966 3982 3999 4018 4019 4026 4036 416 4161 4176 4224 4304 4312 4329 4337 434 4369 4372 4375 4394 444 4449 4463 4474 4497 4516 4518 4539 4542 4549 4553 460 4657 4661 468 4688 4712 4825 4861 4875 4898 4904 4907 4929 4939 4999 5019 5048 5155 52 5224 5254 5290 5309 5343 5356 5402 5410 542 5492 5512 5540 5543 5574 5576 5644 5662 5666 5688 5692 5752 5753 5785 5804 5808 5810 582 5834 5960 5981 5998 6057 6121 6139 6141 6168 6189 6221 6256 6333 6340 6375 645 6468 6471 6475 6520 6553 6567 6580 6594 6598 6636 6677 6727 6741 675 6832 6844 6873 6876 688 6978 7065 7080 7170 7171 7172 7197 7209 7263 7284 7356 7360 7376 7383 7399 7415 7435 7439 75 7504 7507 7517 7519 754 7543 7573 7589 7593 7596 7657 7698 7755 7757 7780 789 792 7929 7935 794 797 7976 799 7996 8024 8086 8092 812 8145 8149 818 8192 8204 8209 8224 8266 8280 8285 831 8325 840 8411 843 8453 849 8511 8515 8520 8549 8554 8558 8582 8638 8641 8663 8676 8677 8685 8696 8770 8851 8859 8863 8909 8948 8977 9065 908 9081 9100 9101 9111 9134 9136 9152 9168 917 9216 9257 9321 9370 9374 94 9409 9411 9440 947 9497 9511 9522 9525 9545 9562 9577 9604 9638 9641 9644 9646 9682 969 9731 9778 9815 9820 9827 9836 9884 9904 9911 9922 9988)

NEWPROCESS=${missing[$LOOP]}

# Copy arguments into meaningful names.
process=${NEWPROCESS}
cluster=${CLUSTER}


# Library building parameters

# In each grid job, do this many voxels:
NVoxelsPerJob=120

# In each voxel, run this many photons:
NPhotonsPerVoxel=500000

# The top voxel for the whole job +1.
NTopVoxel=3253801 

echo $FHICL_FILE_PATH "fhicl file path"
# This works out which voxels this job should focus on: 
FirstVoxel=`echo "($NVoxelsPerJob * $NEWPROCESS ) % $NTopVoxel" | bc`
LastVoxel=`echo "(($NVoxelsPerJob * $NEWPROCESS ) + $NVoxelsPerJob - 1 ) % $NTopVoxel" | bc`


# And then tell the user about it:
echo "This job will run from voxel $FirstVoxel to $LastVoxel, generating $NPhotonsPerVoxel in each"
echo "physics.producers.generator.FirstVoxel: $FirstVoxel" >> $FCL
echo "physics.producers.generator.LastVoxel: $LastVoxel" >> $FCL
echo "physics.producers.generator.N: $NPhotonsPerVoxel">> $FCL
echo "services.TFileService.fileName: \"${process}_hist.root\"" >> $FCL



